<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Outdoor Gear Marketplace (Demo) — Israel ₪</title>
  <style>
    :root{
      --bg:#fafafa; --card:#fff; --text:#111; --muted:#666; --border:#e5e5e5;
      --accent:#111; --accent2:#f3f3f3; --ok:#0a7; --warn:#c60;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    body{ margin:0; background:var(--bg); color:var(--text); }
    header{ background:#fff; border-bottom:1px solid var(--border); position:sticky; top:0; z-index:5; }
    .wrap{ max-width:980px; margin:0 auto; padding:16px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .brand{ display:flex; gap:10px; align-items:center; }
    .logo{ width:36px; height:36px; border-radius:12px; background:#111; }
    .btn{ border:1px solid var(--border); background:#fff; padding:10px 14px; border-radius:14px; cursor:pointer; font-weight:600; }
    .btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:18px; padding:14px; }
    .grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 620px){ .grid{ grid-template-columns: 1fr;} }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; background:var(--accent2); color:var(--muted); font-size:12px; font-weight:600; }
    .muted{ color:var(--muted); }
    .title{ font-size:18px; font-weight:800; }
    .h1{ font-size:22px; font-weight:900; margin:0; }
    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:14px; border:1px solid var(--border);
      font-size:14px; background:#fff; box-sizing:border-box;
    }
    textarea{ min-height:86px; resize:vertical; }
    label{ font-size:12px; font-weight:800; color:var(--muted); display:block; margin-bottom:6px; }
    .two{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width: 700px){ .two{ grid-template-columns:1fr; } }
    .hidden{ display:none !important; }
    .hr{ height:1px; background:var(--border); margin:12px 0; }
    .img{ width:100%; height:160px; object-fit:cover; border-radius:16px; border:1px solid var(--border); background:#eee; }
    .small{ font-size:12px; }
    .chatbox{ height:220px; overflow:auto; border:1px solid var(--border); border-radius:16px; padding:10px; background:#fff; }
    .msg{ max-width:85%; padding:10px 12px; border-radius:16px; margin:8px 0; white-space:pre-line; font-size:14px; }
    .msg.a{ background:var(--accent2); }
    .msg.u{ background:var(--accent); color:#fff; margin-left:auto; }
    .notice{ background:#fff7e6; border:1px solid #ffe1a6; color:#7a4c00; padding:10px 12px; border-radius:16px; }
    .ok{ background:#eafff6; border:1px solid #baf0d8; color:#065f46; padding:10px 12px; border-radius:16px; }
    .link{ color:#111; text-decoration:underline; cursor:pointer; }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div style="font-weight:900;">Outdoor Gear Marketplace</div>
          <div class="small muted">Demo · Israel · Currency ₪ · localStorage (no database)</div>
        </div>
      </div>
      <div class="row">
        <button class="btn" id="btnHome">Home</button>
        <button class="btn primary" id="btnPost">Post an item</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap" id="app"></div>

<script>
/*** =========================
  Simple demo marketplace:
  - One file
  - localStorage listings
  - Mock AI pricing assistant
========================= ***/

const LS_KEY = "ogm_demo_listings_v1";

const CATEGORIES = ["Backpacks","Tents","Sleeping bags","Shoes","Jackets","Stoves","Trekking poles","Other"];

function fmtILS(n){
  const x = Math.round(Number(n)||0);
  return "₪" + x.toLocaleString("en-US");
}
function nanoid(){
  return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function placeholderImg(label){
  const svg = encodeURIComponent(`
  <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800">
    <defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
      <stop offset="0%" stop-color="#111"/><stop offset="100%" stop-color="#666"/>
    </linearGradient></defs>
    <rect width="1200" height="800" fill="url(#g)"/>
    <text x="70" y="700" font-family="Arial" font-size="56" fill="rgba(255,255,255,0.88)">${escapeHtml(label)}</text>
    <text x="70" y="760" font-family="Arial" font-size="26" fill="rgba(255,255,255,0.6)">Demo image</text>
  </svg>`);
  return "data:image/svg+xml;charset=utf-8," + svg;
}

function loadListings(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    const arr = raw ? JSON.parse(raw) : null;
    return Array.isArray(arr) ? arr : [];
  }catch{ return []; }
}
function saveListings(list){
  localStorage.setItem(LS_KEY, JSON.stringify(list));
}
function ensureSeed(){
  const existing = loadListings();
  if(existing.length) return;
  const now = new Date().toISOString();
  const seed = [
    seedListing("Osprey Atmos 65 Backpack","Backpacks","Tel Aviv", now, 5,6,5,"No","No","No","",3, 650,900,820,720, 850),
    seedListing("MSR PocketRocket 2 Stove","Stoves","Haifa", now, 3,6,6,"No","No","No","",4, 140,200,189,165, 190),
    seedListing("Naturehike Cloud Up 2 Tent","Tents","Beer Sheva", now, 4,5,5,"No","No","No","",2, 260,380,349,299, 360),
    seedListing("TNF Thermoball Jacket (Men M)","Jackets","Ramat Gan", now, 3,6,6,"No","No","No","",3, 260,420,399,330, 390),
    seedListing("Decathlon MT500 Trekking Poles","Trekking poles","Modiin", now, 4,5,5,"No","No","No","",6, 70,120,110,85, 95),
  ];
  saveListings(seed);
}
function seedListing(name, category, location, createdAt, used, perf, clean, war, miss, dmg, dmgDesc, urg, low, high, rec, quick, seller){
  return {
    id: "seed-" + nanoid(),
    createdAt,
    productName: name,
    category,
    location,
    photoBase64: placeholderImg(name),
    survey: {
      usedOutdoors1to7: used,
      performanceVsNew1to7: perf,
      cleanness1to7: clean,
      warrantyActiveYesNo: war,
      missingPartsYesNo: miss,
      damagesYesNo: dmg,
      damagesDescription: dmgDesc,
      saleUrgency1to7: urg,
      productName: name
    },
    followUps: [
      {question:"Brand/model and size/spec?", answer:"Demo answer"},
      {question:"Approx age / purchase year?", answer:"Demo answer"},
      {question:"Original new price (approx) ₪?", answer:"Demo answer"}
    ],
    ai: {
      estimatedRangeILS: {low, high},
      recommendedListPriceILS: rec,
      quickSalePriceILS: quick,
      explanation: "Seed demo listing. Condition + category demand used to estimate ₪ range.",
      negotiationTips: `List at ₪${rec}. Accept slightly lower. Quick sale ₪${quick}.`
    },
    sellerChosenListPriceILS: seller
  };
}

/*** ====== Mock AI pricing assistant ====== **/
function baseNewPriceBucket(category){
  switch(category){
    case "Backpacks": return [700,1500];
    case "Tents": return [450,1600];
    case "Sleeping bags": return [400,1400];
    case "Shoes": return [400,900];
    case "Jackets": return [350,1200];
    case "Stoves": return [180,550];
    case "Trekking poles": return [140,500];
    default: return [300,900];
  }
}
function round10(n){ return Math.round(n/10)*10; }
function clamp(min,v,max){ return Math.max(min, Math.min(max,v)); }
function extractNumber(text){
  const m = String(text).replace(/,/g,"").match(/(\d{2,5})/);
  if(!m) return null;
  const n = Number(m[1]);
  return Number.isFinite(n) ? n : null;
}
function generateFollowUps(draft){
  const s = draft.survey;
  const q1 = "Brand + exact model + size/spec (if relevant)?";
  const q2 = (s.warrantyActiveYesNo==="Yes")
    ? "When does the warranty expire (approx), and do you have proof of purchase?"
    : "Approx age / purchase year?";
  const q3 = (s.damagesYesNo==="Yes")
    ? "How does the damage affect function (cosmetic only vs performance), and was it repaired?"
    : "What was the original new price (approx) in ₪ (or a rough new-price estimate)?";
  return [q1,q2,q3];
}
function evaluateMock(draft, answers3){
  const s = draft.survey;
  const [lowB, highB] = baseNewPriceBucket(draft.category);
  let newMid = (lowB + highB)/2;

  const maybe = extractNumber(answers3.join(" "));
  if(maybe && maybe>=80 && maybe<=10000){
    newMid = 0.65*maybe + 0.35*newMid;
  }

  // used ratio baseline
  let usedRatio = 0.55;
  const usePenalty = (s.usedOutdoors1to7 - 1)/6; // 0..1
  const perfBoost = (s.performanceVsNew1to7 - 1)/6;
  const cleanBoost = (s.cleanness1to7 - 1)/6;

  usedRatio -= 0.18*usePenalty;
  usedRatio += 0.10*perfBoost;
  usedRatio += 0.07*cleanBoost;

  if(s.warrantyActiveYesNo==="Yes") usedRatio += 0.05;
  if(s.missingPartsYesNo==="Yes") usedRatio -= 0.12;
  if(s.damagesYesNo==="Yes") usedRatio -= 0.16;

  usedRatio = clamp(0.15, usedRatio, 0.85);

  const urgency01 = (clamp(1,s.saleUrgency1to7,7)-1)/6;

  const fairMid = newMid * usedRatio;
  const fairLow = fairMid * (0.88 - 0.08*urgency01);
  const fairHigh = fairMid * (1.12 - 0.04*urgency01);

  const rec = fairMid * (1.04 - 0.10*urgency01);
  const quick = fairMid * (0.90 - 0.12*urgency01);

  const low = round10(Math.max(20,fairLow));
  const high = round10(Math.max(low+20,fairHigh));
  const recommended = round10(clamp(low, rec, high));
  const quickSale = round10(clamp(20, quick, recommended));

  const explanation =
`Pricing basis: Israeli used-market estimate in ₪ for category "${draft.category}".
Condition factors:
- Used outdoors: ${s.usedOutdoors1to7}/7
- Performance vs new: ${s.performanceVsNew1to7}/7
- Cleanness: ${s.cleanness1to7}/7
- Warranty: ${s.warrantyActiveYesNo}
- Missing parts: ${s.missingPartsYesNo}
- Damages: ${s.damagesYesNo}${(s.damagesYesNo==="Yes" && s.damagesDescription)? " ("+s.damagesDescription+")":""}
- Sale urgency: ${s.saleUrgency1to7}/7

Follow-ups considered:
1) ${answers3[0]}
2) ${answers3[1]}
3) ${answers3[2]}

Result: fair range and recommended listing price optimized for urgency.`;

  const tips =
`List at ₪${recommended}.
Be ready to accept ₪${Math.max(20,recommended-40)}–₪${Math.max(20,recommended-80)} depending on interest.
If you want a faster sale, post ₪${quickSale} and keep the description honest + clear.`;

  return {
    estimatedRangeILS: {low, high},
    recommendedListPriceILS: recommended,
    quickSalePriceILS: quickSale,
    explanation,
    negotiationTips: tips
  };
}

/*** ====== UI rendering (simple router) ====== **/
const app = document.getElementById("app");
document.getElementById("btnHome").onclick = () => goHome();
document.getElementById("btnPost").onclick = () => goPost();

function goHome(){
  ensureSeed();
  const list = loadListings();
  const html = `
    <div class="card">
      <div class="row">
        <div>
          <div class="h1">Marketplace</div>
          <div class="muted small">Demo: seeded listings + your listings saved in this browser.</div>
        </div>
        <div class="row">
          <button class="btn" id="resetBtn">Reset demo data</button>
          <button class="btn primary" id="goPostBtn">Post an item</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="two">
        <div>
          <label>Search</label>
          <input id="q" placeholder="Search by product name…" />
        </div>
        <div>
          <label>Category</label>
          <select id="cat">
            <option value="All">All</option>
            ${CATEGORIES.map(c=>`<option value="${c}">${c}</option>`).join("")}
          </select>
        </div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div id="grid" class="grid"></div>

    <div style="height:12px"></div>
    <div class="card notice">
      <b>Professor note:</b> This is a demo. Listings you add are stored in your browser (localStorage). Seed listings appear for everyone.
    </div>
  `;
  app.innerHTML = html;

  const grid = document.getElementById("grid");
  const q = document.getElementById("q");
  const cat = document.getElementById("cat");

  function render(){
    const qq = q.value.trim().toLowerCase();
    const cc = cat.value;
    const filtered = list.filter(l=>{
      const okQ = qq ? l.productName.toLowerCase().includes(qq) : true;
      const okC = (cc==="All") ? true : l.category===cc;
      return okQ && okC;
    });

    grid.innerHTML = filtered.map(l=>`
      <div class="card" style="cursor:pointer" data-id="${l.id}">
        <img class="img" src="${l.photoBase64}" alt="${escapeHtml(l.productName)}" />
        <div style="margin-top:10px" class="title">${escapeHtml(l.productName)}</div>
        <div style="margin-top:6px; display:flex; gap:6px; flex-wrap:wrap;">
          <span class="pill">${escapeHtml(l.category)}</span>
          <span class="pill">${escapeHtml(l.location)}</span>
        </div>
        <div style="margin-top:10px" class="row">
          <div class="small muted">AI rec.</div>
          <div style="font-weight:900">${fmtILS(l.ai.recommendedListPriceILS)}</div>
        </div>
        <div class="row small muted" style="margin-top:8px">
          <div>Urgency: <b>${l.survey.saleUrgency1to7}</b>/7</div>
          <div>Listed: <b>${l.sellerChosenListPriceILS? fmtILS(l.sellerChosenListPriceILS): "—"}</b></div>
        </div>
      </div>
    `).join("");

    [...grid.querySelectorAll("[data-id]")].forEach(el=>{
      el.onclick = ()=> goDetail(el.getAttribute("data-id"));
    });

    if(!filtered.length){
      grid.innerHTML = `<div class="card"><b>No results.</b> Try another search/category.</div>`;
    }
  }

  render();
  q.oninput = render;
  cat.onchange = render;

  document.getElementById("goPostBtn").onclick = ()=>goPost();
  document.getElementById("resetBtn").onclick = ()=>{
    localStorage.removeItem(LS_KEY);
    ensureSeed();
    goHome();
  };
}

function goDetail(id){
  const list = loadListings();
  const l = list.find(x=>x.id===id);
  if(!l){ app.innerHTML = `<div class="card"><b>Listing not found.</b> <span class="link" id="back">Back</span></div>`; document.getElementById("back").onclick=goHome; return; }

  app.innerHTML = `
    <div class="two">
      <div class="card">
        <img class="img" style="height:320px" src="${l.photoBase64}" alt="${escapeHtml(l.productName)}" />
        <div style="margin-top:12px" class="row">
          <div>
            <div class="h1">${escapeHtml(l.productName)}</div>
            <div style="margin-top:6px; display:flex; gap:6px; flex-wrap:wrap;">
              <span class="pill">${escapeHtml(l.category)}</span>
              <span class="pill">${escapeHtml(l.location)}</span>
            </div>
          </div>
          <button class="btn" id="backBtn">Back</button>
        </div>

        <div class="hr"></div>

        <div class="two">
          <div class="card">
            <div class="small muted">Seller list price</div>
            <div style="font-weight:900; font-size:18px">${l.sellerChosenListPriceILS ? fmtILS(l.sellerChosenListPriceILS) : "Not set"}</div>
          </div>
          <div class="card">
            <div class="small muted">AI recommended</div>
            <div style="font-weight:900; font-size:18px">${fmtILS(l.ai.recommendedListPriceILS)}</div>
            <div class="small muted">Fair: ${fmtILS(l.ai.estimatedRangeILS.low)}–${fmtILS(l.ai.estimatedRangeILS.high)}</div>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="two">
          <div class="card">
            <b>Survey snapshot</b>
            <div class="small muted" style="margin-top:8px; line-height:1.6">
              Used outdoors: <b>${l.survey.usedOutdoors1to7}</b>/7<br/>
              Performance vs new: <b>${l.survey.performanceVsNew1to7}</b>/7<br/>
              Cleanness: <b>${l.survey.cleanness1to7}</b>/7<br/>
              Warranty: <b>${l.survey.warrantyActiveYesNo}</b><br/>
              Missing parts: <b>${l.survey.missingPartsYesNo}</b><br/>
              Damages: <b>${l.survey.damagesYesNo}</b>${l.survey.damagesYesNo==="Yes" && l.survey.damagesDescription ? `<div class="notice" style="margin-top:8px">${escapeHtml(l.survey.damagesDescription)}</div>`:""}<br/>
              Urgency: <b>${l.survey.saleUrgency1to7}</b>/7
            </div>
          </div>
          <div class="card">
            <b>AI explanation</b>
            <div class="small" style="margin-top:8px; white-space:pre-line">${escapeHtml(l.ai.explanation)}</div>
            <div class="hr"></div>
            <b>Negotiation tips</b>
            <div class="small" style="margin-top:8px; white-space:pre-line">${escapeHtml(l.ai.negotiationTips)}</div>
          </div>
        </div>
      </div>

      <div class="card">
        <b>Follow-up answers</b>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:10px;">
          ${l.followUps.map((qa,i)=>`
            <div class="card">
              <div class="small muted">Q${i+1}</div>
              <div style="font-weight:800; margin-top:4px;">${escapeHtml(qa.question)}</div>
              <div class="small" style="margin-top:6px">${escapeHtml(qa.answer)}</div>
            </div>
          `).join("")}
        </div>
        <div style="margin-top:12px" class="notice small">
          Demo: data is stored in your browser (localStorage).
        </div>
      </div>
    </div>
  `;
  document.getElementById("backBtn").onclick = goHome;
}

function goPost(){
  // Step wizard: Basics -> Survey -> AI Chat -> Publish
  let state = {
    step: 1,
    productName: "",
    category: "Backpacks",
    location: "Israel",
    photoBase64: placeholderImg("Upload a photo"),
    survey: {
      usedOutdoors1to7: 4,
      performanceVsNew1to7: 5,
      cleanness1to7: 5,
      warrantyActiveYesNo: "No",
      missingPartsYesNo: "No",
      damagesYesNo: "No",
      damagesDescription: "",
      saleUrgency1to7: 4,
      productName: ""
    },
    followUpsQ: [],
    followUpsA: ["","",""],
    ai: null,
    sellerPrice: ""
  };

  function render(){
    app.innerHTML = `
      <div class="card">
        <div class="row">
          <div>
            <div class="h1">Post an item</div>
            <div class="small muted">Step ${state.step}/4 · No database · Works offline after load</div>
          </div>
          <button class="btn" id="cancelBtn">Cancel</button>
        </div>

        <div class="hr"></div>

        ${state.step===1 ? renderBasics() : ""}
        ${state.step===2 ? renderSurvey() : ""}
        ${state.step===3 ? renderChat() : ""}
        ${state.step===4 ? renderPublish() : ""}

      </div>
    `;

    document.getElementById("cancelBtn").onclick = goHome;

    if(state.step===1) hookBasics();
    if(state.step===2) hookSurvey();
    if(state.step===3) hookChat();
    if(state.step===4) hookPublish();
  }

  function renderBasics(){
    return `
      <div class="two">
        <div>
          <label>Name of the product</label>
          <input id="pn" placeholder="e.g., Osprey Atmos 65 backpack" value="${escapeHtml(state.productName)}" />
          <div class="small muted">Tip: Brand + model helps the price estimate.</div>
        </div>
        <div>
          <label>Category</label>
          <select id="cat">
            ${CATEGORIES.map(c=>`<option value="${c}" ${state.category===c?"selected":""}>${c}</option>`).join("")}
          </select>
        </div>
        <div>
          <label>Location</label>
          <input id="loc" value="${escapeHtml(state.location)}" />
        </div>
        <div>
          <label>Photo (jpg/png)</label>
          <input id="photo" type="file" accept="image/png,image/jpeg" />
          <div class="small muted">Keep it small for a demo (localStorage).</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <img class="img" style="height:260px" id="preview" src="${state.photoBase64}" alt="preview"/>
      </div>

      <div class="hr"></div>
      <div class="row">
        <button class="btn" id="backBtn">Back</button>
        <button class="btn primary" id="nextBtn">Continue</button>
      </div>
    `;
  }

  function hookBasics(){
    const pn = document.getElementById("pn");
    const cat = document.getElementById("cat");
    const loc = document.getElementById("loc");
    const photo = document.getElementById("photo");
    const preview = document.getElementById("preview");

    pn.oninput = ()=> { state.productName = pn.value; state.survey.productName = pn.value; };
    cat.onchange = ()=> { state.category = cat.value; };
    loc.oninput = ()=> { state.location = loc.value; };

    photo.onchange = async ()=> {
      const file = photo.files && photo.files[0];
      if(!file) return;
      if(file.size > 2_500_000){
        alert("Image too large for this demo. Please choose a smaller file (<2.5MB).");
        photo.value = "";
        return;
      }
      const base64 = await fileToDataURL(file);
      state.photoBase64 = base64;
      preview.src = base64;
    };

    document.getElementById("backBtn").onclick = goHome;
    document.getElementById("nextBtn").onclick = ()=>{
      if(!state.productName.trim()) return alert("Please enter a product name.");
      if(!state.photoBase64) return alert("Please add a photo.");
      state.step = 2;
      render();
    };
  }

  function renderSurvey(){
    const s = state.survey;
    return `
      <div class="two">
        ${scoreField("Used outdoors (1–7)", "used", s.usedOutdoors1to7)}
        ${scoreField("Performance vs new (1–7)", "perf", s.performanceVsNew1to7)}
        ${scoreField("Cleanness (1–7)", "clean", s.cleanness1to7)}

        <div>
          <label>Warranty active</label>
          <select id="war">
            <option ${s.warrantyActiveYesNo==="Yes"?"selected":""}>Yes</option>
            <option ${s.warrantyActiveYesNo==="No"?"selected":""}>No</option>
          </select>
        </div>

        <div>
          <label>Missing parts?</label>
          <select id="miss">
            <option ${s.missingPartsYesNo==="No"?"selected":""}>No</option>
            <option ${s.missingPartsYesNo==="Yes"?"selected":""}>Yes</option>
          </select>
        </div>

        <div>
          <label>Damages?</label>
          <select id="dmg">
            <option ${s.damagesYesNo==="No"?"selected":""}>No</option>
            <option ${s.damagesYesNo==="Yes"?"selected":""}>Yes</option>
          </select>
          <div id="dmgBox" class="${s.damagesYesNo==="Yes"?"":"hidden"}" style="margin-top:8px">
            <label>Describe damages</label>
            <textarea id="dmgDesc" placeholder="Describe…">${escapeHtml(s.damagesDescription||"")}</textarea>
          </div>
        </div>

        ${scoreField("Sale urgency (1–7)", "urg", s.saleUrgency1to7)}

        <div>
          <label>Name of the product (read-only)</label>
          <input value="${escapeHtml(state.productName)}" readonly />
        </div>
      </div>

      <div class="hr"></div>
      <div class="row">
        <button class="btn" id="backBtn">Back</button>
        <button class="btn primary" id="nextBtn">Continue to AI chat</button>
      </div>
    `;
  }

  function hookSurvey(){
    const s = state.survey;

    bindScore("used", v=> s.usedOutdoors1to7 = v);
    bindScore("perf", v=> s.performanceVsNew1to7 = v);
    bindScore("clean", v=> s.cleanness1to7 = v);
    bindScore("urg", v=> s.saleUrgency1to7 = v);

    const war = document.getElementById("war");
    const miss = document.getElementById("miss");
    const dmg = document.getElementById("dmg");
    const dmgBox = document.getElementById("dmgBox");
    const dmgDesc = ()=> document.getElementById("dmgDesc");

    war.onchange = ()=> s.warrantyActiveYesNo = war.value;
    miss.onchange = ()=> s.missingPartsYesNo = miss.value;
    dmg.onchange = ()=>{
      s.damagesYesNo = dmg.value;
      if(s.damagesYesNo==="Yes") dmgBox.classList.remove("hidden");
      else dmgBox.classList.add("hidden");
    };

    document.getElementById("backBtn").onclick = ()=>{ state.step = 1; render(); };
    document.getElementById("nextBtn").onclick = ()=>{
      if(s.damagesYesNo==="Yes"){
        const txt = (dmgDesc()?.value||"").trim();
        if(!txt) return alert("Please describe the damages.");
        s.damagesDescription = txt;
      } else {
        s.damagesDescription = "";
      }
      state.step = 3;
      render();
    };
  }

  function renderChat(){
    return `
      <div class="ok small"><b>AI Mode:</b> MOCK (no keys needed) · Currency: ₪</div>
      <div style="height:10px"></div>

      <div class="chatbox" id="chat"></div>

      <div style="height:10px"></div>

      <div id="followupsBox"></div>
      <div id="priceBox" class="hidden"></div>

      <div class="hr"></div>
      <div class="row">
        <button class="btn" id="backBtn">Back</button>
        <button class="btn primary" id="nextBtn" disabled>Continue</button>
      </div>
    `;
  }

  function hookChat(){
    const chat = document.getElementById("chat");
    const followupsBox = document.getElementById("followupsBox");
    const priceBox = document.getElementById("priceBox");
    const nextBtn = document.getElementById("nextBtn");

    function add(role, text){
      const div = document.createElement("div");
      div.className = "msg " + (role==="a" ? "a":"u");
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    // assistant start
    const draft = {
      productName: state.productName.trim(),
      category: state.category,
      location: state.location.trim() || "Israel",
      photoBase64: state.photoBase64,
      survey: {...state.survey, productName: state.productName.trim()}
    };

    add("a", "Hi! I’m your pricing assistant for used outdoor gear in Israel (₪). I’ll ask exactly 3 follow-up questions, then estimate a fair price range.");
    add("a", `Got it — ${draft.productName}. Outdoors ${draft.survey.usedOutdoors1to7}/7, performance ${draft.survey.performanceVsNew1to7}/7, cleanness ${draft.survey.cleanness1to7}/7, warranty ${draft.survey.warrantyActiveYesNo}, missing parts ${draft.survey.missingPartsYesNo}, damages ${draft.survey.damagesYesNo}${(draft.survey.damagesYesNo==="Yes" && draft.survey.damagesDescription)? " ("+draft.survey.damagesDescription+")":""}, urgency ${draft.survey.saleUrgency1to7}/7.`);
    add("a","To price it accurately, I need 3 quick details:");

    state.followUpsQ = generateFollowUps(draft);

    add("a","1) " + state.followUpsQ[0]);
    add("a","2) " + state.followUpsQ[1]);
    add("a","3) " + state.followUpsQ[2]);

    followupsBox.innerHTML = `
      <div class="two">
        ${state.followUpsQ.map((q,i)=>`
          <div>
            <label>${escapeHtml(q)}</label>
            <input id="fu${i}" placeholder="Type your answer…" value="${escapeHtml(state.followUpsA[i]||"")}" />
          </div>
        `).join("")}
      </div>
      <div style="margin-top:10px">
        <button class="btn primary" id="evalBtn">Get price evaluation</button>
      </div>
    `;

    document.getElementById("evalBtn").onclick = ()=>{
      const a0 = (document.getElementById("fu0").value||"").trim();
      const a1 = (document.getElementById("fu1").value||"").trim();
      const a2 = (document.getElementById("fu2").value||"").trim();
      if(!a0 || !a1 || !a2) return alert("Please answer all 3 follow-up questions.");

      state.followUpsA = [a0,a1,a2];
      add("u","A1: "+a0);
      add("u","A2: "+a1);
      add("u","A3: "+a2);

      add("a","Thanks — calculating a fair price in ₪…");

      state.ai = evaluateMock(draft, state.followUpsA);

      add("a",
        `Estimated fair range: ₪${state.ai.estimatedRangeILS.low}–₪${state.ai.estimatedRangeILS.high}\n`+
        `Recommended listing price: ₪${state.ai.recommendedListPriceILS}\n`+
        `Quick-sale price: ₪${state.ai.quickSalePriceILS}`
      );
      add("a","Why:\n"+state.ai.explanation);
      add("a","Negotiation tips:\n"+state.ai.negotiationTips);
      add("a","What price do you want to list it for? (₪)");

      priceBox.classList.remove("hidden");
      priceBox.innerHTML = `
        <div class="two">
          <div>
            <label>Your list price (₪)</label>
            <input id="sellerPrice" placeholder="e.g., 550" inputmode="numeric" />
            <div class="small muted">Recommended: ${fmtILS(state.ai.recommendedListPriceILS)} · Quick: ${fmtILS(state.ai.quickSalePriceILS)}</div>
          </div>
          <div style="display:flex; align-items:end;">
            <button class="btn primary" id="savePriceBtn">Save price</button>
          </div>
        </div>
      `;

      document.getElementById("savePriceBtn").onclick = ()=>{
        const v = Number((document.getElementById("sellerPrice").value||"").trim());
        if(!Number.isFinite(v) || v<=0) return alert("Enter a valid positive number in ₪.");
        state.sellerPrice = String(Math.round(v));
        add("u","I want to list it for ₪"+state.sellerPrice);
        add("a","Great — saved. You can continue.");
        nextBtn.disabled = false;
      };
    };

    document.getElementById("backBtn").onclick = ()=>{ state.step = 2; render(); };
    nextBtn.onclick = ()=>{ state.step = 4; render(); };
  }

  function renderPublish(){
    return `
      <div class="two">
        <div>
          <img class="img" style="height:260px" src="${state.photoBase64}" alt="preview"/>
        </div>
        <div>
          <div class="card">
            <div class="small muted">Product</div>
            <div class="title" style="margin-top:6px">${escapeHtml(state.productName)}</div>
            <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;">
              <span class="pill">${escapeHtml(state.category)}</span>
              <span class="pill">${escapeHtml(state.location)}</span>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="card">
            <div class="small muted">AI recommended</div>
            <div style="font-weight:900; font-size:18px">${fmtILS(state.ai.recommendedListPriceILS)}</div>
            <div class="small muted">Fair: ${fmtILS(state.ai.estimatedRangeILS.low)}–${fmtILS(state.ai.estimatedRangeILS.high)} · Quick: ${fmtILS(state.ai.quickSalePriceILS)}</div>
          </div>

          <div style="height:10px"></div>

          <div class="card">
            <div class="small muted">Seller list price</div>
            <div style="font-weight:900; font-size:18px">₪${escapeHtml(state.sellerPrice)}</div>
          </div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="row">
        <button class="btn" id="backBtn">Back</button>
        <button class="btn primary" id="publishBtn">Publish to marketplace</button>
      </div>

      <div style="margin-top:10px" class="notice small">
        Publishing saves to your browser (localStorage). Then it appears on Home.
      </div>
    `;
  }

  function hookPublish(){
    document.getElementById("backBtn").onclick = ()=>{ state.step = 3; render(); };
    document.getElementById("publishBtn").onclick = ()=>{
      const listing = {
        id: nanoid(),
        createdAt: new Date().toISOString(),
        productName: state.productName.trim(),
        category: state.category,
        location: state.location.trim() || "Israel",
        photoBase64: state.photoBase64,
        survey: {...state.survey, productName: state.productName.trim()},
        followUps: state.followUpsQ.map((q,i)=>({question:q, answer: state.followUpsA[i]})),
        ai: state.ai,
        sellerChosenListPriceILS: Number(state.sellerPrice)
      };
      const list = loadListings();
      list.unshift(listing);
      saveListings(list);
      goHome();
    };
  }

  function scoreField(labelText, key, value){
    return `
      <div>
        <label>${labelText}</label>
        <div class="two" style="grid-template-columns:90px 1fr;">
          <input id="${key}" type="number" min="1" max="7" value="${value}" />
          <div class="small muted" style="align-self:center">1=low · 4=medium · 7=high</div>
        </div>
      </div>
    `;
  }
  function bindScore(key, setter){
    const el = document.getElementById(key);
    el.oninput = ()=>{
      let v = Number(el.value);
      if(!Number.isFinite(v)) v = 4;
      v = clamp(1, Math.round(v), 7);
      el.value = v;
      setter(v);
    };
  }
  async function fileToDataURL(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(String(r.result||""));
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  render();
}

// Start
ensureSeed();
goHome();
</script>
</body>
</html>
